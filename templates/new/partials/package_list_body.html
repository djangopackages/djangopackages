{% load i18n humanize %}

<div id="package-list-state" class="hidden">
    <input type="hidden" name="category" value="{{ current_category }}">
    <input type="hidden" name="sort" value="{{ current_sort }}">
</div>

{% if request.htmx %}
    <div id="package-categories-container" hx-swap-oob="true">
        {% include "new/partials/package_categories.html" %}
    </div>
{% endif %}

<!-- Table -->
<div class="overflow-x-auto w-full">
            <table class="w-full text-sm text-left">
            <thead>
                <tr class="text-left border-b">
                    <th class="pb-3 pr-6 font-medium text-muted-foreground">
                        <button class="flex items-center gap-1 hover:text-foreground"
                            hx-get="{% url 'packages' %}?category={{ current_category }}&sort={% if current_sort == 'title' %}-title{% elif current_sort == '-title' %}{% else %}title{% endif %}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true">
                            <i class="ph-bold ph-package text-lg"></i>
                            {% translate "Title" %}
                            {% if current_sort == 'title' or current_sort == '-title' %}
                                <i class="ph-bold {% if current_sort == 'title' %}ph-caret-up{% else %}ph-caret-down{% endif %}"></i>
                            {% else %}
                                <i class="ph-bold ph-caret-up-down opacity-50"></i>
                            {% endif %}
                        </button>
                    </th>
                    <th class="pb-3 font-medium text-muted-foreground hidden sm:table-cell">
                        <button class="flex items-center gap-1 hover:text-foreground"
                            hx-get="{% url 'packages' %}?category={{ current_category }}&sort={% if current_sort == 'category' %}-category{% elif current_sort == '-category' %}{% else %}category{% endif %}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true">
                            <i class="ph-bold ph-tag text-lg"></i>
                            {% translate "Category" %}
                            {% if current_sort == 'category' or current_sort == '-category' %}
                                <i class="ph-bold {% if current_sort == 'category' %}ph-caret-up{% else %}ph-caret-down{% endif %}"></i>
                            {% else %}
                                <i class="ph-bold ph-caret-up-down opacity-50"></i>
                            {% endif %}
                        </button>
                    </th>
                    <th class="pb-3 font-medium text-muted-foreground hidden md:table-cell">
                        <div class="flex items-center gap-1">
                            <i class="ph-bold ph-hash text-lg"></i>
                            {% translate "Version" %}
                        </div>
                    </th>
                    <th class="pb-3 font-medium text-muted-foreground hidden lg:table-cell">
                        <button class="flex items-center gap-1 hover:text-foreground"
                            hx-get="{% url 'packages' %}?category={{ current_category }}&sort={% if current_sort == '-usage_count' %}usage_count{% elif current_sort == 'usage_count' %}{% else %}-usage_count{% endif %}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true">
                            <i class="ph-bold ph-users text-lg"></i>
                            {% translate "Usage" %}
                            {% if current_sort == 'usage_count' or current_sort == '-usage_count' %}
                                <i class="ph-bold {% if current_sort == 'usage_count' %}ph-caret-up{% else %}ph-caret-down{% endif %}"></i>
                            {% else %}
                                <i class="ph-bold ph-caret-up-down opacity-50"></i>
                            {% endif %}
                        </button>
                    </th>
                    <th class="pb-3 font-medium text-muted-foreground">
                        <button class="flex items-center gap-1 hover:text-foreground"
                            hx-get="{% url 'packages' %}?category={{ current_category }}&sort={% if current_sort == '-repo_watchers' %}repo_watchers{% elif current_sort == 'repo_watchers' %}{% else %}-repo_watchers{% endif %}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true">
                            <i class="ph-bold ph-star text-lg"></i>
                            <span class="sm:inline">{% translate "Stars" %}</span>
                            {% if current_sort == 'repo_watchers' or current_sort == '-repo_watchers' %}
                                <i class="ph-bold {% if current_sort == 'repo_watchers' %}ph-caret-up{% else %}ph-caret-down{% endif %}"></i>
                            {% else %}
                                <i class="ph-bold ph-caret-up-down opacity-50"></i>
                            {% endif %}
                        </button>
                    </th>
                    <th class="pb-3 font-medium text-muted-foreground">
                        <button class="flex items-center gap-1 hover:text-foreground"
                            hx-get="{% url 'packages' %}?category={{ current_category }}&sort={% if current_sort == '-repo_forks' %}repo_forks{% elif current_sort == 'repo_forks' %}{% else %}-repo_forks{% endif %}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true">
                            <i class="ph-bold ph-git-fork text-lg"></i>
                            <span class="sm:inline">{% translate "Forks" %}</span>
                            {% if current_sort == 'repo_forks' or current_sort == '-repo_forks' %}
                                <i class="ph-bold {% if current_sort == 'repo_forks' %}ph-caret-up{% else %}ph-caret-down{% endif %}"></i>
                            {% else %}
                                <i class="ph-bold ph-caret-up-down opacity-50"></i>
                            {% endif %}
                        </button>
                    </th>
                    <th class="pb-3 font-medium text-muted-foreground hidden lg:table-cell">
                        <button class="flex items-center gap-1 hover:text-foreground"
                            hx-get="{% url 'packages' %}?category={{ current_category }}&sort={% if current_sort == '-last_fetched' %}last_fetched{% elif current_sort == 'last_fetched' %}{% else %}-last_fetched{% endif %}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true">
                            <i class="ph-bold ph-clock text-lg"></i>
                            {% translate "Updated" %}
                            {% if current_sort == 'last_fetched' or current_sort == '-last_fetched' %}
                                <i class="ph-bold {% if current_sort == 'last_fetched' %}ph-caret-up{% else %}ph-caret-down{% endif %}"></i>
                            {% else %}
                                <i class="ph-bold ph-caret-up-down opacity-50"></i>
                            {% endif %}
                        </button>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for package in packages %}
                    <tr class="border-b transition-colors last:border-0 hover:bg-muted/30">
                        <td class="py-3 pr-6 max-w-[10rem] sm:max-w-[15rem] md:max-w-[20rem]">
                            <div class="flex flex-col">
                                <a href="{% url 'package' package.slug %}" class="font-semibold hover:underline text-primary text-base truncate block" title="{{ package.title }}">{{ package.title }}</a>
                                <p class="text-muted-foreground text-xs truncate mt-1" title="{{ package.repo_description|default:"" }}">{{ package.repo_description|default:"" }}</p>

                                <!-- Mobile/Tablet Badges -->
                                <div class="flex flex-wrap gap-2 mt-2">
                                    {% if package.category %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-secondary text-secondary-foreground sm:hidden">
                                            {{ package.category.title }}
                                        </span>
                                    {% endif %}

                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-muted text-muted-foreground md:hidden" title="{% translate 'Latest PyPI Version' %}">
                                        <i class="ph-bold ph-hash mr-1"></i> {{ package.pypi_version|default:"-" }}
                                    </span>

                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-muted text-muted-foreground lg:hidden" title="{% translate 'Usage Count' %}">
                                        <i class="ph-bold ph-users mr-1"></i> {{ package.usage_count|intcomma }}
                                    </span>

                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-muted text-muted-foreground lg:hidden" title="{% translate 'Last Updated' %}">
                                        <i class="ph-bold ph-clock mr-1"></i> {{ package.last_fetched|date:"M d, Y"|default:"-" }}
                                    </span>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 hidden sm:table-cell">
                            {% if package.category %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-secondary text-secondary-foreground hover:bg-secondary/80">
                                    {{ package.category.title }}
                                </span>
                            {% endif %}
                        </td>
                        <td class="py-3 font-mono text-sm hidden md:table-cell">
                            {{ package.pypi_version|default:"-" }}
                        </td>
                        <td class="py-3 font-mono text-sm hidden lg:table-cell">
                            {{ package.usage_count|intcomma }}
                        </td>
                        <td class="py-3 font-mono text-sm">
                            {{ package.repo_watchers|intcomma|default:"-" }}
                        </td>
                        <td class="py-3 font-mono text-sm">
                            {{ package.repo_forks|intcomma|default:"-" }}
                        </td>
                        <td class="py-3 text-sm text-muted-foreground hidden lg:table-cell">
                            {{ package.last_fetched|date:"M d, Y"|default:"-" }}
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="7" class="p-8 text-center text-muted-foreground">
                            {% translate "No packages found." %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
    <div class="mt-8 flex justify-center">
        <div class="inline-flex flex-wrap gap-1 items-center">
            <button
                {% if page_obj.has_previous %}
                    hx-get="{% url 'packages' %}?page={{ page_obj.previous_page_number }}&category={{ current_category }}&sort={{ current_sort }}&q={{ search_query }}"
                    hx-target="#package-list-container"
                    hx-push-url="true"
                {% else %}
                    disabled
                {% endif %}
                class="inline-flex justify-center items-center px-2 h-9 text-sm font-medium whitespace-nowrap rounded-md transition-colors sm:px-3 disabled:opacity-50 disabled:pointer-events-none hover:bg-accent hover:text-accent-foreground border border-input bg-background">
                <i class="mr-1 ph-bold ph-caret-left"></i>
                <span class="hidden sm:inline">{% translate "Previous" %}</span>
            </button>

            <div class="inline-flex gap-1 items-center">
                {% for i in page_obj.paginator.page_range %}
                    {% if page_obj.number == i %}
                        <button
                            class="inline-flex justify-center items-center w-9 h-9 text-sm font-medium whitespace-nowrap rounded-md transition-colors bg-primary text-primary-foreground">
                            {{ i }}
                        </button>
                    {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                        <button
                            hx-get="{% url 'packages' %}?page={{ i }}&category={{ current_category }}&sort={{ current_sort }}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true"
                            class="inline-flex justify-center items-center w-9 h-9 text-sm font-medium whitespace-nowrap rounded-md transition-colors hover:bg-accent hover:text-accent-foreground border border-input bg-background">
                            {{ i }}
                        </button>
                    {% endif %}
                {% endfor %}
            </div>

            <button
                {% if page_obj.has_next %}
                    hx-get="{% url 'packages' %}?page={{ page_obj.next_page_number }}&category={{ current_category }}&sort={{ current_sort }}&q={{ search_query }}"
                    hx-target="#package-list-container"
                    hx-push-url="true"
                {% else %}
                    disabled
                {% endif %}
                class="inline-flex justify-center items-center px-2 h-9 text-sm font-medium whitespace-nowrap rounded-md transition-colors sm:px-3 disabled:opacity-50 disabled:pointer-events-none hover:bg-accent hover:text-accent-foreground border border-input bg-background">
                <span class="hidden sm:inline">{% translate "Next" %}</span>
                <i class="ml-1 ph-bold ph-caret-right"></i>
            </button>
        </div>
    </div>
{% endif %}
