{% load humanize i18n %}

<div id="package-list-state" class="hidden">
    <input type="hidden" name="category" value="{{ current_category }}">
    <input type="hidden" name="sort" value="{{ current_sort }}">
</div>

{% if request.htmx %}
    <div id="package-categories-container" hx-swap-oob="true">
        {% include "new/partials/package_categories.html" %}
    </div>
{% endif %}

<!-- Table -->
<div class="overflow-x-auto w-full">
    <table class="w-full text-sm text-left">
        <thead>
            <tr class="text-left border-b">
                <th class="pr-6 pb-3 font-medium text-muted-foreground">
                    <button class="flex gap-1 items-center hover:text-foreground"
                            hx-get="{{ list_url }}?category={{ current_category }}&sort={% if current_sort == 'title' %}-title{% elif current_sort == '-title' %}{% else %}title{% endif %}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true">
                        <i class="text-lg ph-bold ph-package"></i>
                        {% translate "Title" %}
                        {% if current_sort == 'title' or current_sort == '-title' %}
                            <i class="ph-bold {% if current_sort == 'title' %}ph-caret-up{% else %}ph-caret-down{% endif %}"></i>
                        {% else %}
                            <i class="opacity-50 ph-bold ph-caret-up-down"></i>
                        {% endif %}
                    </button>
                </th>
                <th class="hidden pb-3 font-medium sm:table-cell text-muted-foreground">
                    <button class="flex gap-1 items-center hover:text-foreground"
                            hx-get="{{ list_url }}?category={{ current_category }}&sort={% if current_sort == 'category' %}-category{% elif current_sort == '-category' %}{% else %}category{% endif %}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true">
                        <i class="text-lg ph-bold ph-tag"></i>
                        {% translate "Category" %}
                        {% if current_sort == 'category' or current_sort == '-category' %}
                            <i class="ph-bold {% if current_sort == 'category' %}ph-caret-up{% else %}ph-caret-down{% endif %}"></i>
                        {% else %}
                            <i class="opacity-50 ph-bold ph-caret-up-down"></i>
                        {% endif %}
                    </button>
                </th>
                <th class="hidden pb-3 font-medium md:table-cell text-muted-foreground">
                    <div class="flex gap-1 items-center">
                        <i class="text-lg ph-bold ph-hash"></i>
                        {% translate "Version" %}
                    </div>
                </th>
                <th class="hidden pb-3 font-medium lg:table-cell text-muted-foreground">
                    <button class="flex gap-1 items-center hover:text-foreground"
                            hx-get="{{ list_url }}?category={{ current_category }}&sort={% if current_sort == '-usage_count' %}usage_count{% elif current_sort == 'usage_count' %}{% else %}-usage_count{% endif %}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true">
                        <i class="text-lg ph-bold ph-users"></i>
                        {% translate "Usage" %}
                        {% if current_sort == 'usage_count' or current_sort == '-usage_count' %}
                            <i class="ph-bold {% if current_sort == 'usage_count' %}ph-caret-up{% else %}ph-caret-down{% endif %}"></i>
                        {% else %}
                            <i class="opacity-50 ph-bold ph-caret-up-down"></i>
                        {% endif %}
                    </button>
                </th>
                <th class="pb-3 font-medium text-muted-foreground">
                    <button class="flex gap-1 items-center hover:text-foreground"
                            hx-get="{{ list_url }}?category={{ current_category }}&sort={% if current_sort == '-repo_watchers' %}repo_watchers{% elif current_sort == 'repo_watchers' %}{% else %}-repo_watchers{% endif %}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true">
                        <i class="text-lg ph-bold ph-star"></i>
                        <span class="sm:inline">{% translate "Stars" %}</span>
                        {% if current_sort == 'repo_watchers' or current_sort == '-repo_watchers' %}
                            <i class="ph-bold {% if current_sort == 'repo_watchers' %}ph-caret-up{% else %}ph-caret-down{% endif %}"></i>
                        {% else %}
                            <i class="opacity-50 ph-bold ph-caret-up-down"></i>
                        {% endif %}
                    </button>
                </th>
                <th class="pb-3 font-medium text-muted-foreground">
                    <button class="flex gap-1 items-center hover:text-foreground"
                            hx-get="{{ list_url }}?category={{ current_category }}&sort={% if current_sort == '-repo_forks' %}repo_forks{% elif current_sort == 'repo_forks' %}{% else %}-repo_forks{% endif %}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true">
                        <i class="text-lg ph-bold ph-git-fork"></i>
                        <span class="sm:inline">{% translate "Forks" %}</span>
                        {% if current_sort == 'repo_forks' or current_sort == '-repo_forks' %}
                            <i class="ph-bold {% if current_sort == 'repo_forks' %}ph-caret-up{% else %}ph-caret-down{% endif %}"></i>
                        {% else %}
                            <i class="opacity-50 ph-bold ph-caret-up-down"></i>
                        {% endif %}
                    </button>
                </th>
                <th class="hidden pb-3 font-medium lg:table-cell text-muted-foreground">
                    <button class="flex gap-1 items-center hover:text-foreground"
                            hx-get="{{ list_url }}?category={{ current_category }}&sort={% if current_sort == '-last_fetched' %}last_fetched{% elif current_sort == 'last_fetched' %}{% else %}-last_fetched{% endif %}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true">
                        <i class="text-lg ph-bold ph-clock"></i>
                        {% translate "Updated" %}
                        {% if current_sort == 'last_fetched' or current_sort == '-last_fetched' %}
                            <i class="ph-bold {% if current_sort == 'last_fetched' %}ph-caret-up{% else %}ph-caret-down{% endif %}"></i>
                        {% else %}
                            <i class="opacity-50 ph-bold ph-caret-up-down"></i>
                        {% endif %}
                    </button>
                </th>
            </tr>
        </thead>
        <tbody>
            {% for package in packages %}
                <tr class="border-b transition-colors last:border-0 hover:bg-muted/30">
                    <td class="py-3 pr-6 max-w-[10rem] sm:max-w-[15rem] md:max-w-[20rem]">
                        <div class="flex flex-col">
                            <a href="{% url 'package' package.slug %}" class="block text-base font-semibold hover:underline text-primary truncate" title="{{ package.title }}">{{ package.title }}</a>
                            <p class="mt-1 text-xs text-muted-foreground truncate" title="{{ package.repo_description|default:"" }}">{{ package.repo_description|default:"" }}</p>

                                <!-- Mobile/Tablet Badges -->
                            <div class="flex flex-wrap gap-2 mt-2">
                                {% if package.category %}
                                    <span class="inline-flex items-center py-0.5 px-2 text-xs font-medium rounded sm:hidden bg-secondary text-secondary-foreground">
                                        {{ package.category.title }}
                                    </span>
                                {% endif %}

                                <span class="inline-flex items-center py-0.5 px-2 text-xs font-medium rounded md:hidden bg-muted text-muted-foreground" title="{% translate 'Latest PyPI Version' %}">
                                    <i class="mr-1 ph-bold ph-hash"></i> {{ package.pypi_version|default:"-" }}
                                </span>

                                <span class="inline-flex items-center py-0.5 px-2 text-xs font-medium rounded lg:hidden bg-muted text-muted-foreground" title="{% translate 'Usage Count' %}">
                                    <i class="mr-1 ph-bold ph-users"></i> {{ package.usage_count|intcomma }}
                                </span>

                                <span class="inline-flex items-center py-0.5 px-2 text-xs font-medium rounded lg:hidden bg-muted text-muted-foreground" title="{% translate 'Last Updated' %}">
                                    <i class="mr-1 ph-bold ph-clock"></i> {{ package.last_fetched|date:"M d, Y"|default:"-" }}
                                </span>
                            </div>
                        </div>
                    </td>
                    <td class="hidden py-3 sm:table-cell">
                        {% if package.category %}
                            <span class="inline-flex items-center py-0.5 px-2.5 text-xs font-medium rounded-full bg-secondary text-secondary-foreground hover:bg-secondary/80">
                                {{ package.category.title }}
                            </span>
                        {% endif %}
                    </td>
                    <td class="hidden py-3 font-mono text-sm md:table-cell">
                        {{ package.pypi_version|default:"-" }}
                    </td>
                    <td class="hidden py-3 font-mono text-sm lg:table-cell">
                        {{ package.usage_count|intcomma }}
                    </td>
                    <td class="py-3 font-mono text-sm">
                        {{ package.repo_watchers|intcomma|default:"-" }}
                    </td>
                    <td class="py-3 font-mono text-sm">
                        {{ package.repo_forks|intcomma|default:"-" }}
                    </td>
                    <td class="hidden py-3 text-sm lg:table-cell text-muted-foreground">
                        {{ package.last_fetched|date:"M d, Y"|default:"-" }}
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="7" class="p-8 text-center text-muted-foreground">
                        {% translate "No packages found." %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
    <div class="flex justify-center mt-8">
        <div class="inline-flex flex-wrap gap-1 items-center">
            <button
                {% if page_obj.has_previous %}
                    hx-get="{{ list_url }}?page={{ page_obj.previous_page_number }}&category={{ current_category }}&sort={{ current_sort }}&q={{ search_query }}"
                    hx-target="#package-list-container"
                    hx-push-url="true"
                {% else %}
                    disabled
                {% endif %}
                class="inline-flex justify-center items-center px-2 h-9 text-sm font-medium whitespace-nowrap rounded-md border transition-colors sm:px-3 disabled:opacity-50 disabled:pointer-events-none border-input bg-background hover:bg-accent hover:text-accent-foreground">
                <i class="mr-1 ph-bold ph-caret-left"></i>
                <span class="hidden sm:inline">{% translate "Previous" %}</span>
            </button>

            <div class="inline-flex gap-1 items-center">
                {% for i in page_obj.paginator.page_range %}
                    {% if page_obj.number == i %}
                        <button
                            class="inline-flex justify-center items-center w-9 h-9 text-sm font-medium whitespace-nowrap rounded-md transition-colors bg-primary text-primary-foreground">
                            {{ i }}
                        </button>
                    {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                        <button
                            hx-get="{{ list_url }}?page={{ i }}&category={{ current_category }}&sort={{ current_sort }}&q={{ search_query }}"
                            hx-target="#package-list-container"
                            hx-push-url="true"
                            class="inline-flex justify-center items-center w-9 h-9 text-sm font-medium whitespace-nowrap rounded-md border transition-colors border-input bg-background hover:bg-accent hover:text-accent-foreground">
                            {{ i }}
                        </button>
                    {% endif %}
                {% endfor %}
            </div>

            <button
                {% if page_obj.has_next %}
                    hx-get="{{ list_url }}?page={{ page_obj.next_page_number }}&category={{ current_category }}&sort={{ current_sort }}&q={{ search_query }}"
                    hx-target="#package-list-container"
                    hx-push-url="true"
                {% else %}
                    disabled
                {% endif %}
                class="inline-flex justify-center items-center px-2 h-9 text-sm font-medium whitespace-nowrap rounded-md border transition-colors sm:px-3 disabled:opacity-50 disabled:pointer-events-none border-input bg-background hover:bg-accent hover:text-accent-foreground">
                <span class="hidden sm:inline">{% translate "Next" %}</span>
                <i class="ml-1 ph-bold ph-caret-right"></i>
            </button>
        </div>
    </div>
{% endif %}
