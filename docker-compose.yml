x-common-settings: &common-settings
  build:
    context: .
    dockerfile: ./dockerfiles/django/Dockerfile-dev
  depends_on:
    - postgres
    - redis
  env_file:
    - .env.local
  volumes:
    - .:/app
    - djpkg_static_dev:/data/static
    - djpkg_media_dev:/data/media

services:
  django:
    <<: *common-settings
    command: /start-dev.sh
    init: true
    ports:
      - "8000:8000"

  django-q:
    <<: *common-settings
    command: python manage.py qcluster
    init: true

  postgres:
    # image: "pgautoupgrade/pgautoupgrade:latest"
    build: ./dockerfiles/postgres
    expose:
      - 5432
    healthcheck:
      test: [
          "CMD",
          "/usr/local/bin/healthcheck_pg.sh",
      ]
      interval: 3s
      timeout: 3s
      retries: 30
    init: true
    volumes:
      - djpkg_postgres_data_dev:/var/lib/postgresql/data
      - djpkg_postgres_backup_dev:/backups

  redis:
    image: redis:7
    expose:
      - 6379
    init: true

  docs:
    <<: *common-settings
    command: sh -c "mkdocs serve -f docs/mkdocs.yml --dev-addr 0.0.0.0:4000"
    entrypoint: ""
    environment:
      FAST_MODE: "true"
      LIVE_RELOAD_SUPPORT: "true"
    init: true
    ports:
      - "4000:4000"
    profiles:
      - docs

  utility:
    <<: *common-settings
    init: true
    profiles:
      - utility

volumes:
  djpkg_media_dev: {}
  djpkg_postgres_backup_dev: {}
  djpkg_postgres_data_dev: {}
  djpkg_static_dev: {}
